<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <a href="home.html" class="navbar-brand">Attendance System</a>
        <div class="navbar-links">
            <a href="admin_add_class.html">Add Class</a>
            <a href="admin_add_student.html">Add Student</a>
            <a href="admin_add_lecture.html">Add Lecture</a>
            <a href="admin_mark_attendance.html">Mark Attendance</a>
            <a href="admin_report.html">Report</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>
    <div class="container">
        <header>
            <h1>Attendance View</h1>
        </header>
        <div class="panel">
            <div class="filter-controls">
                <div class="form-group">
                    <label for="classFilter">Class</label>
                    <select id="classFilter">
                        <option value="">All Classes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subjectFilter">Subject</label>
                    <select id="subjectFilter">
                        <option value="">All Subjects</option>
                    </select>
                </div>
                <button onclick="searchAttendance()">Search</button>
                <button onclick="resetFilters()">Reset</button>
            </div>
            <div id="loadingIndicator" class="loading" style="display: none;">Loading...</div>
            <div id="attendanceList" class="section">
                <h2>Attendance Records</h2>
                <table id="attendanceTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Subject</th>
                            <th>Student</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="js/config.js"></script>
    <script>
        // Cache for storing data
        const dataCache = {
            classes: { data: null, timestamp: null },
            students: { data: null, timestamp: null },
            lectures: { data: null, timestamp: null },
            attendance: { data: null, timestamp: null }
        };
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // Load initial data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
        });

        async function fetchWithCache(url, cacheKey) {
            const now = Date.now();
            if (dataCache[cacheKey] && now - dataCache[cacheKey].timestamp < CACHE_DURATION) {
                return dataCache[cacheKey].data;
            }

            const response = await fetch(url);
            const data = await response.json();
            dataCache[cacheKey] = {
                data: data,
                timestamp: now
            };
            return data;
        }

        async function loadInitialData() {
            try {
                const [classes, students, lectures, attendance] = await Promise.all([
                    fetchWithCache(`${API_CONFIG.CLASS_SERVICE}/api/classes`, 'classes'),
                    fetchWithCache(`${API_CONFIG.STUDENT_SERVICE}/api/students`, 'students'),
                    fetchWithCache(`${API_CONFIG.LECTURE_SERVICE}/api/lectures`, 'lectures'),
                    fetchWithCache(`${API_CONFIG.ATTENDANCE_SERVICE}/api/attendance`, 'attendance')
                ]);

                // Populate class filter
                const classFilter = document.getElementById('classFilter');
                classFilter.innerHTML = '<option value="">All Classes</option>';
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    classFilter.appendChild(option);
                });

                // Create lookup maps for faster access
                dataCache.studentMap = new Map(students.map(s => [s.id, s]));
                dataCache.lectureMap = new Map(lectures.map(l => [l.id, l]));
                dataCache.classMap = new Map(classes.map(c => [c.id, c]));

                // Display all attendance records
                displayAttendanceRecords(attendance);
            } catch (error) {
                console.error('Error loading initial data:', error);
                alert('Error loading data. Please refresh the page.');
            }
        }

        // Update subjects when class is selected
        document.getElementById('classFilter').addEventListener('change', function() {
            const classId = this.value;
            const subjectFilter = document.getElementById('subjectFilter');
            subjectFilter.innerHTML = '<option value="">All Subjects</option>';

            if (classId) {
                const classLectures = dataCache.lectures.data.filter(l => l.class_id == classId);
                const subjects = [...new Set(classLectures.map(l => l.name))];
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectFilter.appendChild(option);
                });
            }
        });

        function displayAttendanceRecords(records) {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';

            if (records.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="no-data">No records found</td>';
                tbody.appendChild(row);
                return;
            }

            // Sort records by date and time
            records.sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateB - dateA;
            });

            records.forEach(record => {
                const lecture = dataCache.lectureMap.get(record.lecture_id);
                const student = dataCache.studentMap.get(record.student_id);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.time}</td>
                    <td>${lecture ? lecture.name : 'N/A'}</td>
                    <td>${student ? student.name : 'N/A'}</td>
                    <td>${record.status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchAttendance() {
            const classId = document.getElementById('classFilter').value;
            const subject = document.getElementById('subjectFilter').value;

            let filteredRecords = dataCache.attendance.data;

            if (classId) {
                filteredRecords = filteredRecords.filter(record => {
                    const lecture = dataCache.lectureMap.get(record.lecture_id);
                    return lecture && lecture.class_id == classId;
                });
            }

            if (subject) {
                filteredRecords = filteredRecords.filter(record => {
                    const lecture = dataCache.lectureMap.get(record.lecture_id);
                    return lecture && lecture.name === subject;
                });
            }

            displayAttendanceRecords(filteredRecords);
        }

        function resetFilters() {
            document.getElementById('classFilter').value = '';
            document.getElementById('subjectFilter').value = '';
            displayAttendanceRecords(dataCache.attendance.data);
        }

        function logout() {
            sessionStorage.removeItem('isAdminLoggedIn');
            window.location.href = 'login.html';
        }
    </script>
    <style>
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .attendance-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .attendance-table tr:hover {
            background-color: #f5f5f5;
        }

        .status-present {
            color: #28a745;
            font-weight: bold;
        }

        .status-absent {
            color: #dc3545;
            font-weight: bold;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</body>
</html> 